default_platform(:android)

def generate_changelog(log_range)
  repo_url = "https://github.com/shekohex/whisperpp"
  # Format: Hash|Subject
  cmd = "git log #{log_range} --pretty=format:'%H|%s'"
  begin
    raw_log = sh(cmd).strip
  rescue => ex
    UI.error("Error generating changelog: #{ex}")
    return "No changes detected."
  end
  
  features = []
  fixes = []
  perf = []
  docs = []
  chore = []
  others = []
  
  raw_log.each_line do |line|
    parts = line.strip.split('|', 2)
    next if parts.length < 2
    hash = parts[0]
    msg = parts[1]
    
    # Short hash for display, full hash for link
    short_hash = hash[0, 7]
    link = "[#{short_hash}](#{repo_url}/commit/#{hash})"
    
    # Detect type to categorize
    type_match = msg.match(/^(feat|fix|perf|docs|chore|test|style|refactor)(\(.*\))?:\s*/i)
    
    # Strip the prefix for the display message
    if type_match
      clean_msg = msg.sub(type_match[0], '')
    else
      clean_msg = msg
    end
    
    # Capitalize first letter
    clean_msg = clean_msg[0].upcase + clean_msg[1..-1] if clean_msg.length > 0
    
    entry = "#{clean_msg} (#{link})"

    if msg.match?(/^feat/i)
      features << entry
    elsif msg.match?(/^fix/i)
      fixes << entry
    elsif msg.match?(/^perf/i)
      perf << entry
    elsif msg.match?(/^docs/i)
      docs << entry
    elsif msg.match?(/^chore/i)
      chore << entry
    else
      others << entry
    end
  end
  
  changelog = ""
  changelog += "### âœ¨ New Features\n#{features.map{|l| "* #{l}"}.join("\n")}\n\n" unless features.empty?
  changelog += "### ðŸ› Bug Fixes\n#{fixes.map{|l| "* #{l}"}.join("\n")}\n\n" unless fixes.empty?
  changelog += "### ðŸš€ Performance Improvements\n#{perf.map{|l| "* #{l}"}.join("\n")}\n\n" unless perf.empty?
  changelog += "### ðŸ“ Documentation\n#{docs.map{|l| "* #{l}"}.join("\n")}\n\n" unless docs.empty?
  changelog += "### ðŸ›  Maintenance\n#{chore.map{|l| "* #{l}"}.join("\n")}\n\n" unless chore.empty?
  changelog += "### ðŸ—’ Other Changes\n#{others.map{|l| "* #{l}"}.join("\n")}\n\n" unless others.empty?
  
  return changelog.empty? ? "No changes detected." : changelog
end

platform :android do
  desc "Build and release a nightly APK"
  lane :nightly do
    # Generate short SHA for version name
    sha = sh("git rev-parse --short HEAD").strip
    version_name = "nightly-#{sha}"
    
    # Calculate version code based on run number if available
    version_code = ENV["GITHUB_RUN_NUMBER"] || "1"

    # Generate Changelog for Nightly (last 24h or since last tag)
    begin
      previous_tag = sh("git describe --tags --abbrev=0 HEAD^").strip
      log_range = "#{previous_tag}..HEAD"
    rescue
      log_range = "--since='24 hours ago'"
    end
    
    changelog = generate_changelog(log_range)
    
    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "android/",
      flags: "--no-daemon",
      properties: {
        "versionCode" => version_code,
        "versionName" => version_name,
        "signingStoreFile" => File.expand_path("../android/app/release.jks", __dir__),
        "signingStorePassword" => ENV["KEYSTORE_PASSWORD"],
        "signingKeyAlias" => ENV["KEY_ALIAS"],
        "signingKeyPassword" => ENV["KEY_PASSWORD"],
      }
    )

    # Use a rolling tag for nightly
    # Create release notes file
    header = "<p align='center'><img alt='Whisper++ Logo' src='https://raw.githubusercontent.com/shekohex/whisperpp/main/app_icon.svg' width='200'></p><br>"
    notes = "#{header}\n\nAutomated nightly build from branch main.\n\n## Changes in this build\n#{changelog}\n\n### Downloads\n| Artifact | Version | Link |\n| :--- | :--- | :--- |\n| **Whisper++ APK** | `#{version_name}` | [Download APK](https://github.com/shekohex/whisperpp/releases/download/nightly/app-release.apk) |"
    File.write("nightly_notes.md", notes)

    # Clean up old nightly tag and release using gh CLI
    sh("gh release delete nightly --yes --cleanup-tag --repo shekohex/whisperpp || true")

    # Create new release using gh CLI
    apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    sh("gh release create nightly \"#{apk_path}\" --repo shekohex/whisperpp --target main --title 'Nightly Build' --notes-file nightly_notes.md --prerelease")
  end

  desc "Build and release a tagged version"
  lane :release do
    # Get tag name from environment
    tag = ENV["GITHUB_REF_NAME"]
    version_code = ENV["GITHUB_RUN_NUMBER"] || "1"

    # Generate Changelog
    begin
      previous_tag = sh("git describe --tags --abbrev=0 --match 'v*' HEAD^").strip
      log_range = "#{previous_tag}..HEAD"
    rescue
      log_range = ""
    end
    
    changelog = generate_changelog(log_range)

    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "android/",
      flags: "--no-daemon",
      properties: {
        "versionCode" => version_code,
        "versionName" => tag,
        "signingStoreFile" => File.expand_path("../android/app/release.jks", __dir__),
        "signingStorePassword" => ENV["KEYSTORE_PASSWORD"],
        "signingKeyAlias" => ENV["KEY_ALIAS"],
        "signingKeyPassword" => ENV["KEY_PASSWORD"],
      }
    )

    # Create release notes file
    header = "<p align='center'><img alt='Whisper++ Logo' src='https://raw.githubusercontent.com/shekohex/whisperpp/main/app_icon.svg' width='200'></p><br>"
    notes = "#{header}\n\n## Changelog\n#{changelog}\n\n### Downloads\n| Artifact | Version | Link |\n| :--- | :--- | :--- |\n| **Whisper++ APK** | `#{tag}` | [Download APK](https://github.com/shekohex/whisperpp/releases/download/#{tag}/app-release.apk) |"
    File.write("release_notes.md", notes)

    apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    sh("gh release create #{tag} \"#{apk_path}\" --repo shekohex/whisperpp --title 'Release #{tag}' --notes-file release_notes.md")
  end
end
